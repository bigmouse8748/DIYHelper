<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tool Identification - DIY Smart Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f5f7fa;
        }

        /* Header */
        .header {
            background: #ffffff;
            border-bottom: 1px solid #e4e7ed;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-section {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo-icon {
            font-size: 28px;
        }

        .site-title {
            font-size: 20px;
            font-weight: 700;
            color: #303133;
        }

        .user-section {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a6fd8;
        }

        .btn-secondary {
            background: transparent;
            color: #606266;
            border: 1px solid #dcdfe6;
        }

        .btn-secondary:hover {
            color: #667eea;
            border-color: #667eea;
        }

        /* Main Content */
        .main-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .page-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .page-title {
            font-size: 36px;
            font-weight: 700;
            color: #303133;
            margin-bottom: 16px;
        }

        .page-subtitle {
            font-size: 18px;
            color: #606266;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Upload Section */
        .upload-section {
            background: white;
            border-radius: 12px;
            padding: 40px;
            margin-bottom: 40px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .upload-area {
            border: 2px dashed #dcdfe6;
            border-radius: 12px;
            padding: 60px 20px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-area.dragover {
            border-color: #667eea;
            background: #f8f9ff;
        }

        .upload-icon {
            font-size: 48px;
            color: #c0c4cc;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            color: #606266;
            margin-bottom: 16px;
        }

        .upload-hint {
            font-size: 14px;
            color: #909399;
        }

        .file-input {
            display: none;
        }

        .upload-button {
            margin-top: 20px;
        }

        /* Preview Section */
        .preview-section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 32px;
            margin-bottom: 40px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .preview-title {
            font-size: 20px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 20px;
        }

        .image-preview {
            max-width: 100%;
            max-height: 400px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }

        /* Loading */
        /* Progress Section */
        .progress-section {
            display: none;
            margin: 30px auto;
            padding: 30px 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .progress-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .progress-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
        }

        .progress-percentage {
            font-size: 16px;
            font-weight: 600;
            color: #667eea;
        }

        .progress-bar-container {
            background: #f5f7fa;
            border-radius: 10px;
            height: 8px;
            margin-bottom: 15px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.8s ease;
            width: 0%;
        }

        .progress-step {
            font-size: 14px;
            color: #606266;
            margin-bottom: 8px;
        }

        /* Uploaded Images Display */
        .uploaded-images-display {
            display: none;
            margin: 30px auto;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.05);
        }

        .uploaded-images-title {
            font-size: 18px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .uploaded-image-item {
            text-align: center;
            margin-bottom: 20px;
        }

        .uploaded-image {
            max-width: 300px;
            max-height: 200px;
            width: auto;
            height: auto;
            border-radius: 8px;
            border: 2px solid #e4e7ed;
            object-fit: cover;
        }

        .uploaded-image-label {
            font-size: 14px;
            color: #606266;
            margin-top: 8px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Results Section */
        .results-section {
            display: none;
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .results-title {
            font-size: 24px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 24px;
        }

        .tool-info {
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .tool-name {
            font-size: 20px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 8px;
        }

        .tool-description {
            color: #606266;
            margin-bottom: 16px;
        }

        .tool-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .detail-label {
            font-weight: 500;
            color: #303133;
        }

        .detail-value {
            color: #606266;
        }

        /* Product Recommendations */
        .recommendations-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .product-card {
            border: 1px solid #e4e7ed;
            border-radius: 8px;
            padding: 20px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
        }

        .product-image {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 6px;
            margin-bottom: 16px;
        }

        .product-name {
            font-size: 16px;
            font-weight: 600;
            color: #303133;
            margin-bottom: 8px;
        }

        .product-price {
            font-size: 18px;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 8px;
        }

        .product-retailer {
            font-size: 14px;
            color: #909399;
            margin-bottom: 16px;
        }

        .exact-match-badge {
            background: #67c23a;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
            display: inline-block;
        }

        .out-of-stock {
            background: #f56c6c;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 8px;
            display: inline-block;
        }

        .no-results {
            text-align: center;
            padding: 40px;
            color: #909399;
            font-size: 16px;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .toast.success {
            background: #67c23a;
        }

        .toast.error {
            background: #f56c6c;
        }

        .toast.show {
            transform: translateX(0);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header-container {
                padding: 0 16px;
                height: 60px;
            }
            
            .main-content {
                padding: 24px 16px;
            }
            
            .page-title {
                font-size: 28px;
            }
            
            .upload-section {
                padding: 24px;
            }
            
            .upload-area {
                padding: 40px 20px;
            }
            
            .tool-details {
                grid-template-columns: 1fr;
            }
            
            .recommendations-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="logo-section">
                <div class="logo-icon">🔨</div>
                <h1 class="site-title" id="siteTitle">DIY Smart Assistant</h1>
            </div>
            
            <div class="user-section">
                
                <button class="btn btn-secondary" onclick="goBack()" id="backBtn">← Back</button>
                <button class="btn btn-secondary" onclick="logout()" id="logoutBtn">Sign Out</button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Page Header -->
        <section class="page-header">
            <h1 class="page-title" id="pageTitle">Tool Identification</h1>
            <p class="page-subtitle" id="pageSubtitle">
                Upload an image of any tool and get instant AI-powered identification with detailed information and purchase recommendations.
            </p>
        </section>

        <!-- Upload Section -->
        <section class="upload-section">
            <div class="upload-area" id="uploadArea" onclick="triggerFileInput()">
                <div class="upload-icon">📷</div>
                <div class="upload-text" id="uploadText">Click to upload or drag and drop</div>
                <div class="upload-hint" id="uploadHint">Supports JPG, PNG, GIF up to 10MB</div>
                <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileSelect(event)">
                <button class="btn btn-primary upload-button" id="uploadButton">Choose File</button>
            </div>
        </section>

        <!-- Preview Section -->
        <section class="preview-section" id="previewSection">
            <h3 class="preview-title" id="previewTitle">Uploaded Image</h3>
            <img id="imagePreview" class="image-preview" alt="Tool preview">
            <button class="btn btn-primary" onclick="analyzeImage()" id="analyzeBtn">Analyze Tool</button>
            <button class="btn btn-secondary" onclick="resetUpload()" id="resetBtn">Upload Different Image</button>
        </section>

        <!-- Progress Section -->
        <section class="progress-section" id="progressSection">
            <div class="progress-header">
                <h3 class="progress-title" id="progressTitle">Analyzing Tool</h3>
                <span class="progress-percentage" id="progressPercentage">0%</span>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="progress-step" id="progressStep">Starting analysis...</div>
        </section>

        <!-- Uploaded Images Display -->
        <section class="uploaded-images-display" id="uploadedImagesDisplay">
            <h3 class="uploaded-images-title">
                <span>📷</span>
                <span id="uploadedImagesTitle">Uploaded Image</span>
            </h3>
            <div id="uploadedImagesContainer">
                <!-- Uploaded images will be displayed here -->
            </div>
        </section>

        <!-- Loading -->
        <section class="loading" id="loading">
            <div class="spinner"></div>
            <p id="loadingText">Analyzing your tool...</p>
        </section>

        <!-- Results Section -->
        <section class="results-section" id="resultsSection">
            <h2 class="results-title" id="resultsTitle">Identification Results</h2>
            
            <div class="tool-info" id="toolInfo">
                <!-- Tool information will be populated here -->
            </div>
            
            <h3 id="recommendationsTitle" style="margin-bottom: 20px;">Purchase Recommendations</h3>
            <div class="recommendations-grid" id="recommendationsGrid">
                <!-- Product recommendations will be populated here -->
            </div>
        </section>
    </main>

    <div class="toast" id="toast">
        <span id="toastMessage"></span>
    </div>

    <script>

        let selectedFile = null;

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toastMessage');
            
            toastMessage.textContent = message;
            toast.className = `toast ${type}`;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function goBack() {
            window.location.href = 'dashboard.html';
        }

        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('user_data');
            window.location.href = 'standalone.html';
        }

        function triggerFileInput() {
            document.getElementById('fileInput').click();
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showToast('Please select a valid image file', 'error');
                return;
            }

            // Validate file size (10MB)
            if (file.size > 10 * 1024 * 1024) {
                showToast('File size must be less than 10MB', 'error');
                return;
            }

            selectedFile = file;
            displayPreview(file);
            
            // Display uploaded image immediately
            displayUploadedImage(file);
        }

        function displayPreview(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('previewSection').style.display = 'block';
                document.querySelector('.upload-section').style.display = 'none';
            };
            reader.readAsDataURL(file);
        }

        function resetUpload() {
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('resultsSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';
            document.getElementById('uploadedImagesDisplay').style.display = 'none';
            document.querySelector('.upload-section').style.display = 'block';
            
            // Reset progress bar
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';
            document.getElementById('progressStep').textContent = '';
        }

        async function analyzeImage() {
            if (!selectedFile) return;

            // Hide preview section and show progress section
            document.getElementById('previewSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'block';
            document.getElementById('uploadedImagesDisplay').style.display = 'block';
            
            // Reset progress bar
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressPercentage').textContent = '0%';

            try {
                // Simulate progress steps
                const steps = [
                    { progress: 10, text: 'Uploading image...' },
                    { progress: 30, text: 'Processing image...' },
                    { progress: 60, text: 'Analyzing tool features...' },
                    { progress: 80, text: 'Identifying tool details...' },
                    { progress: 95, text: 'Generating recommendations...' }
                ];

                // Show initial step
                updateProgress(steps[0].progress, steps[0].text);
                await new Promise(resolve => setTimeout(resolve, 500));

                const formData = new FormData();
                formData.append('image', selectedFile);

                // Update progress to 30%
                updateProgress(steps[1].progress, steps[1].text);
                await new Promise(resolve => setTimeout(resolve, 800));

                const token = localStorage.getItem('access_token');
                
                // Update progress to 60%
                updateProgress(steps[2].progress, steps[2].text);
                await new Promise(resolve => setTimeout(resolve, 600));
                
                const response = await fetch('http://localhost:8000/api/v1/agents/tool-identification/analyze', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Analysis failed');
                }

                // Update progress to 80%
                updateProgress(steps[3].progress, steps[3].text);
                await new Promise(resolve => setTimeout(resolve, 400));

                const result = await response.json();
                
                // Update progress to 95%
                updateProgress(steps[4].progress, steps[4].text);
                await new Promise(resolve => setTimeout(resolve, 500));
                
                // Complete progress
                updateProgress(100, 'Analysis complete!');
                await new Promise(resolve => setTimeout(resolve, 300));

                // Hide progress section and show results
                document.getElementById('progressSection').style.display = 'none';
                displayResults(result);

            } catch (error) {
                console.error('Analysis error:', error);
                showToast('Analysis failed. Please try again.', 'error');
                document.getElementById('progressSection').style.display = 'none';
                document.getElementById('previewSection').style.display = 'block';
            }
        }

        function updateProgress(percentage, stepText) {
            document.getElementById('progressBar').style.width = percentage + '%';
            document.getElementById('progressPercentage').textContent = percentage + '%';
            document.getElementById('progressStep').textContent = stepText;
        }

        function displayUploadedImage(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const uploadedImagesContainer = document.getElementById('uploadedImagesContainer');
                uploadedImagesContainer.innerHTML = `
                    <div class="uploaded-image-item">
                        <img src="${e.target.result}" class="uploaded-image" alt="Uploaded tool image">
                        <div class="uploaded-image-label">${file.name} (${formatFileSize(file.size)})</div>
                    </div>
                `;
                
                // Show the uploaded images section
                document.getElementById('uploadedImagesDisplay').style.display = 'block';
            };
            reader.readAsDataURL(file);
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        function displayResults(result) {
            // Use actual API response data
            const data = result.data;
            const toolInfo = data.tool_info;
            const shoppingLinks = data.shopping_links || [];
            
            // Display tool information
            const toolInfoElement = document.getElementById('toolInfo');
            const toolName = `${toolInfo.brand || ''} ${toolInfo.name || 'Unknown Tool'}`.trim();
            const confidence = Math.round((toolInfo.confidence || 0) * 100);
            const category = toolInfo.category ? toolInfo.category.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'Unknown';
            
            toolInfoElement.innerHTML = `
                <div class="tool-name">${toolName}</div>
                <div class="tool-description">Tool identified with ${confidence}% confidence</div>
                <div class="tool-details">
                    <div class="detail-item">
                        <span class="detail-label">Category:</span>
                        <span class="detail-value">${category}</span>
                    </div>
                    ${toolInfo.brand ? `
                        <div class="detail-item">
                            <span class="detail-label">Brand:</span>
                            <span class="detail-value">${toolInfo.brand}</span>
                        </div>
                    ` : ''}
                    ${toolInfo.model ? `
                        <div class="detail-item">
                            <span class="detail-label">Model:</span>
                            <span class="detail-value">${toolInfo.model}</span>
                        </div>
                    ` : ''}
                    <div class="detail-item">
                        <span class="detail-label">Confidence:</span>
                        <span class="detail-value">${confidence}%</span>
                    </div>
                    ${toolInfo.specifications ? Object.entries(toolInfo.specifications).map(([key, value]) => `
                        <div class="detail-item">
                            <span class="detail-label">${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span>
                            <span class="detail-value">${value}</span>
                        </div>
                    `).join('') : ''}
                </div>
            `;

            // Display product recommendations
            const recommendationsGrid = document.getElementById('recommendationsGrid');
            if (shoppingLinks.length > 0) {
                recommendationsGrid.innerHTML = shoppingLinks.map(product => `
                    <div class="product-card">
                        <img src="${product.image_url || 'https://via.placeholder.com/300x200?text=No+Image'}" alt="${product.title}" class="product-image" onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
                        <div class="product-name">${product.title}</div>
                        <div class="product-price">$${product.price.toFixed(2)}</div>
                        <div class="product-retailer">${product.retailer}</div>
                        ${product.is_exact_match ? '<div class="exact-match-badge">Exact Match</div>' : ''}
                        ${!product.in_stock ? '<div class="out-of-stock">Out of Stock</div>' : ''}
                        <button class="btn btn-primary" onclick="window.open('${product.url}', '_blank')" ${!product.in_stock ? 'disabled' : ''}>
                            View Product
                        </button>
                    </div>
                `).join('');
            } else {
                recommendationsGrid.innerHTML = '<div class="no-results">No shopping links found for this tool.</div>';
            }

            // Show results section and keep uploaded images visible
            document.getElementById('resultsSection').style.display = 'block';
            document.getElementById('uploadedImagesDisplay').style.display = 'block';
        }

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFileSelect({ target: { files } });
            }
        });

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            
        });
    
    </script>
</body>
</html>